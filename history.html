<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Incident History - HonMaku Status</title>
        <meta
            name="description"
            content="Historical incident reports for our services"
        />
        <link rel="stylesheet" href="src/css/style.css" />
    </head>
    <body class="history-page">
        <div class="container">
            <header>
                <div class="header-top">
                    <a
                        href="https://honmaku.vercel.app"
                        class="home-link"
                        title="Back to Home"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path
                                d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                            ></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </a>
                    <a
                        href="https://github.com/lhmchyd/HonMaku-Status"
                        class="repo-link"
                        title="View Repository"
                        target="_blank"
                        rel="noopener noreferrer"
                    >
                        <span>Built with üíñ by HonMƒÅku</span>
                    </a>
                </div>
            </header>
            
            <h1>Incident History</h1>
            <p class="metadata">All historical incidents organized by month</p>

            <div class="history-section">
                <div id="history-container">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <footer>
                <div class="footer-content">
                    <div class="history-nav">
                        <a href="index.html" class="history-link history-link-text-only">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m12 19-7-7 7-7"></path>
                            <path d="M19 12H5"></path>
                        </svg>
                            Back to Status
                        </a>
                    </div>
                </div>
                <p>Automatically refreshed based on GitHub Actions schedule</p>
            </footer>
        </div>

        <script src="src/js/script.js"></script>
        <script>
            // Load incidents history when the page loads
            document.addEventListener('DOMContentLoaded', async function() {
                try {
                    // Load incidents
                    const incidentsResponse = await fetch("status-incidents.json?t=" + Date.now());
                    let incidents = [];
                    if (incidentsResponse.ok) {
                        incidents = await incidentsResponse.json();
                    }

                    // Group incidents by month
                    const incidentsByMonth = {};
                    const months = [
                        "January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"
                    ];

                    incidents.forEach((incident) => {
                        const incidentDate = new Date(incident.timestamp * 1000);
                        const monthKey = `${incidentDate.getFullYear()}-${String(incidentDate.getMonth() + 1).padStart(2, '0')}`;
                        const monthName = `${months[incidentDate.getMonth()]} ${incidentDate.getFullYear()}`;
                        
                        if (!incidentsByMonth[monthKey]) {
                            incidentsByMonth[monthKey] = {
                                monthName: monthName,
                                year: incidentDate.getFullYear(),
                                month: incidentDate.getMonth(),
                                incidents: []
                            };
                        }
                        
                        incidentsByMonth[monthKey].incidents.push(incident);
                    });

                    // Convert to array and sort by date (most recent first)
                    const sortedMonths = Object.keys(incidentsByMonth)
                        .map(key => incidentsByMonth[key])
                        .sort((a, b) => {
                            // Sort by year first, then by month
                            if (b.year !== a.year) {
                                return b.year - a.year;
                            }
                            return b.month - a.month;
                        });

                    // Update history section with incidents grouped by month
                    const historyContainer = document.getElementById("history-container");
                    historyContainer.innerHTML = "";

                    if (sortedMonths.length > 0) {
                        sortedMonths.forEach((monthGroup) => {
                            const monthElement = document.createElement("div");
                            monthElement.className = "incident-month";

                            // Format the month header
                            const monthHeader = document.createElement("h2");
                            monthHeader.className = "incident-month-header";
                            monthHeader.textContent = monthGroup.monthName;

                            const monthIncidentsContainer = document.createElement("div");
                            monthIncidentsContainer.className = "incident-list";

                            // Sort incidents within the month by date (most recent first)
                            monthGroup.incidents.sort((a, b) => b.timestamp - a.timestamp);

                            // Add each incident for this month
                            monthGroup.incidents.forEach((incident, index) => {
                                const incidentDate = new Date(incident.timestamp * 1000);
                                const incidentDateStr = incidentDate.toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });

                                const incidentElement = document.createElement("div");
                                incidentElement.className = "incident-item";
                                if (index >= 3) {
                                    incidentElement.style.display = 'none';
                                    incidentElement.classList.add('hidden-incident');
                                }
                                incidentElement.innerHTML = `
                                    <div class="incident-item-content">
                                        <div class="incident-service">${incident.name || incident.service}</div>
                                        <span class="incident-separator">-</span>
                                        <div class="incident-details">${incident.error}</div>
                                    </div>
                                    <div class="incident-date">${incidentDateStr}</div>
                                `;

                                monthIncidentsContainer.appendChild(incidentElement);
                            });

                            // Add show more button if there are more than 3 incidents
                            if (monthGroup.incidents.length > 3) {
                                const showMoreContainer = document.createElement("div");
                                showMoreContainer.className = "show-more-container";
                                showMoreContainer.innerHTML = `
                                    <button class="show-more-btn" data-month="${monthGroup.monthName}">
                                        + Show All ${monthGroup.incidents.length} Incidents
                                    </button>
                                `;

                                // Add click handler to show all incidents for this month
                                showMoreContainer.querySelector('.show-more-btn').addEventListener('click', function() {
                                    const hiddenIncidents = monthIncidentsContainer.querySelectorAll('.hidden-incident');
                                    hiddenIncidents.forEach(incident => {
                                        incident.style.display = 'flex';
                                    });
                                    showMoreContainer.style.display = 'none'; // Hide the button after showing all
                                });

                                monthElement.appendChild(monthHeader);
                                monthElement.appendChild(monthIncidentsContainer);
                                monthElement.appendChild(showMoreContainer);
                            } else {
                                monthElement.appendChild(monthHeader);
                                monthElement.appendChild(monthIncidentsContainer);
                            }

                            historyContainer.appendChild(monthElement);
                        });
                    } else {
                        historyContainer.innerHTML = '<div class="no-incidents">No incidents reported.</div>';
                    }
                } catch (error) {
                    console.error("Error loading incident history:", error);
                    const historyContainer = document.getElementById("history-container");
                    historyContainer.innerHTML = '<div class="no-incidents">Error loading incident history.</div>';
                }
            });
        </script>
    </body>
</html>